@using CODE_QUESTS.Models
@model List<DebuggingQuestion>
@{
    ViewData["Title"] = "Play Quiz";
    ViewData["BodyClass"] = "dashboard-bg";
}

<div class="quiz-container">
    <div class="quiz-header">
        <img src="~/images/Component 2.png" alt="Wizard Mascot" />
        <h2>@ViewData["QuizTitle"]</h2>
    </div>

    <div class="quiz-status-bar">
        <div class="quiz-timer">Timer: <span id="time-left">20</span>s</div>
        <div class="progress-bar-container"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
        <div class="quiz-score">Score: <span id="score-text">0</span></div>
        <a asp-controller="Quizzes" asp-action="Index" class="end-quiz-btn">End Quiz</a>
    </div>

    <div class="quiz-card">
        <div class="quiz-question-pane">
            <h1 id="question-text">Find the bug!</h1>
            <pre id="code-problem" class="code-display"></pre>
            <h2 id="feedback-text" style="display:none;"></h2>
        </div>

        <div class="quiz-options-pane">
            <input type="text" id="answer-input" class="code-input" placeholder="Type your answer here..." autocomplete="off" />
            <button id="submit-btn" class="submit-btn">Submit Answer</button>

            <div id="solution-area" style="display:none; margin-top: 1rem;">
                <p><strong>Solution:</strong></p>
                <p id="code-solution" style="font-size: 24px; font-weight: bold; color: #059669;"></p>
            </div>

            <a href="#" id="next-btn" class="submit-btn" style="display:none; margin-top: 2rem;">Next Question</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // FIX: Wrapped in JSON.parse to fix the red warning line
        const quizData = JSON.parse('@Html.Raw(Json.Serialize(Model))');

        let currentQuestionIndex = 0;
        let score = 0;
        let timeLeft = 20;
        let timerInterval;

        const questionText = document.getElementById("question-text");
        const codeProblem = document.getElementById("code-problem");
        const codeSolution = document.getElementById("code-solution");
        const feedbackText = document.getElementById("feedback-text");
        const answerInput = document.getElementById("answer-input");
        const submitButton = document.getElementById("submit-btn");
        const nextButton = document.getElementById("next-btn");
        const solutionArea = document.getElementById("solution-area");
        const scoreText = document.getElementById("score-text");
        const timeLeftText = document.getElementById("time-left");
        const progressBar = document.getElementById("progress-bar-fill");
        const questionTitle = document.getElementById("question-text");

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            showQuestion();
        }

        function showQuestion() {
            feedbackText.style.display = "none";
            nextButton.style.display = "none";
            solutionArea.style.display = "none";
            submitButton.style.display = "flex";
            answerInput.style.display = "block";
            answerInput.value = "";
            answerInput.disabled = false;

            let question = quizData[currentQuestionIndex];
            if(!question) {
                 questionTitle.innerText = "No questions available.";
                 return;
            }

            codeProblem.innerText = question.codeProblem;
            codeSolution.innerText = question.codeSolution;

            const progressPercent = ((currentQuestionIndex + 1) / quizData.length) * 100;
            progressBar.style.width = progressPercent + "%";
            startTimer();
        }

        function startTimer() {
            timeLeft = 20;
            timeLeftText.innerText = timeLeft;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timeLeftText.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer();
                }
            }, 1000);
        }

        function checkAnswer() {
            clearInterval(timerInterval);
            let question = quizData[currentQuestionIndex];
            let userAnswer = answerInput.value.trim();
            let correctAnswer = question.codeSolution.trim();

            let isCorrect = (userAnswer.length > 0 && correctAnswer.toLowerCase().includes(userAnswer.toLowerCase()));

            if (isCorrect) {
                score += 100;
                scoreText.innerText = score;
                feedbackText.innerText = "You're Correct! +100 Points";
                feedbackText.className = "feedback-correct";
            } else {
                feedbackText.innerText = "Incorrect!";
                feedbackText.className = "feedback-wrong";
            }
            showAnswer();
        }

        function showAnswer() {
            feedbackText.style.display = "block";
            nextButton.style.display = "flex";
            submitButton.style.display = "none";
            answerInput.disabled = true;
            solutionArea.style.display = "block";
        }

        submitButton.addEventListener("click", checkAnswer);

        nextButton.addEventListener("click", () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                showQuestion();
            } else {
                questionTitle.innerText = "Quiz Complete!";
                codeProblem.style.display = "none";
                feedbackText.innerText = "Your final score is " + score;
                feedbackText.className = "feedback-correct";
                solutionArea.style.display = "none";
                answerInput.style.display = "none";

                nextButton.innerText = "Back to Quizzes";
                // Remove old event listener by cloning
                const newButton = nextButton.cloneNode(true);
                nextButton.parentNode.replaceChild(newButton, nextButton);
                newButton.addEventListener("click", function() {
                    window.location.href = "@Url.Action("Index", "Quizzes")";
                });
            }
        });

        startQuiz();
    </script>
}